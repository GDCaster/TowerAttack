<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Battle War: Node.js</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;600&display=swap" rel="stylesheet">
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì 100% */
        :root { --bg: #0f0f0f; --ui: #1a1a1a; --gold: #FFD700; }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; font-family: 'Kanit', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
        .screen { display: none; width: 100%; height: 100%; position: absolute; z-index: 20; background: var(--bg); flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex !important; }
        input, select { padding: 15px; border-radius: 12px; border: 1px solid #444; background: #333; color: white; text-align: center; font-size: 1.2rem; width: 80%; max-width: 300px; margin: 8px; }
        .btn { padding: 15px 35px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; margin: 10px; font-size: 1.1rem; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.95); }
        .btn-gold { background: var(--gold); color: black; }
        .btn-gray { background: #444; color: #aaa; }
        .color-row { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }
        .color-btn { width: 35px; height: 35px; border-radius: 50%; border: 3px solid #333; cursor: pointer; transition: 0.2s; }
        .color-btn.selected { border-color: white; box-shadow: 0 0 10px white; }
        .color-btn.taken { opacity: 0.2; cursor: not-allowed; border-color: #333; }
        .lobby-box { width: 90%; max-width: 700px; background: var(--ui); padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .team-container { display: flex; gap: 10px; margin-top: 20px; min-height: 250px; }
        .team-col { flex: 1; background: rgba(0,0,0,0.2); border: 2px dashed #333; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .player-item { width: 100%; padding: 10px; background: #2a2a2a; margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; border-left: 5px solid transparent; }
        .ready-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #444; color: #888; }
        .ready-tag.yes { background: #22c55e; color: white; }
        #viewport { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1; background: #050505; touch-action: none; cursor: grab; }
        #viewport:active { cursor: grabbing; }
        #world { position: absolute; top: 0; left: 0; width: 1600px; height: 900px; background: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 80%); border: 5px solid #333; }
        .base { position: absolute; top: 50%; transform: translate(-50%, -50%); z-index: 5; text-align: center; }
        .base-icon { font-size: 5rem; filter: drop-shadow(0 0 20px rgba(0,0,0,0.6)); transition: transform 0.1s; }
        .hp-bar { width: 120px; height: 10px; background: #222; border: 1px solid #555; margin-top: 5px; border-radius: 4px; overflow: hidden; position: relative; left: 50%; transform: translateX(-50%); }
        .hp-fill { height: 100%; width: 100%; transition: width 0.1s; }
        .unit { position: absolute; width: 28px; height: 28px; border-radius: 50%; transform: translate(-50%, -50%); z-index: 10; display: flex; justify-content: center; align-items: center; font-size: 14px; box-shadow: 0 3px 5px rgba(0,0,0,0.5); transition: left 0.05s linear, top 0.05s linear; color: white; font-weight: bold; text-shadow: 0 0 2px black; border: 2px solid white; }
        #hud { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 30; }
        .energy-box { position: absolute; bottom: 160px; left: 50%; transform: translateX(-50%); font-size: 1.8rem; font-weight: bold; color: var(--gold); background: rgba(0,0,0,0.8); padding: 5px 30px; border-radius: 50px; border: 2px solid var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .dock { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.9); padding: 10px 15px; border-radius: 25px; display: flex; gap: 10px; pointer-events: auto; backdrop-filter: blur(10px); border: 1px solid #444; width: 95%; max-width: 500px; justify-content: center; }
        .card { flex: 1; height: 90px; background: #333; border-radius: 12px; border: 2px solid #555; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: 0.1s; }
        .card:active { transform: scale(0.9); }
        .card.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        .cost-badge { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: var(--gold); color: black; border-radius: 50%; font-weight: bold; font-size: 0.8rem; display: flex; justify-content: center; align-items: center; border: 2px solid #222; }
        #resultScreen { background: rgba(0,0,0,0.95); }
        #winnerText { font-size: 4rem; margin-bottom: 20px; text-shadow: 0 0 30px rgba(255,215,0,0.5); text-align: center; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="menuScreen" class="screen active">
        <h1 style="color:var(--gold); font-size:3rem; margin-bottom:10px;">BATTLE WAR</h1>
        <p style="color:#666; margin-bottom:30px;">Node.js Edition</p>
        <input type="text" id="playerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡πà‡∏ó‡∏±‡∏û" maxlength="12">
        <select id="gameMode">
            <option value="1v1">‡πÇ‡∏´‡∏°‡∏î 1 vs 1</option>
            <option value="bot">‡πÇ‡∏´‡∏°‡∏î 1 vs Bot</option>
        </select>
        <div style="margin-top:20px; width:100%; text-align:center;">
            <button class="btn btn-gold" onclick="createRoom()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° / ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
        <div style="margin-top:30px; border-top:1px solid #333; padding-top:20px; display:flex; gap:10px; justify-content:center;">
            <input type="text" id="roomCodeInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á" style="width:140px;">
            <button class="btn btn-gray" onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
        </div>
    </div>

    <div id="lobbyScreen" class="screen">
        <div class="lobby-box">
            <h2 id="lobbyTitle">Room: ...</h2>
            <div style="text-align:center; margin-top:15px; background:#222; padding:10px; border-radius:10px;">
                <small style="color:#aaa;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Å‡∏≠‡∏á‡∏ó‡∏±‡∏û</small>
                <div class="color-row" id="colorPicker"></div>
            </div>
            <div class="team-container">
                <div class="team-col">
                    <h3 style="color:#ef4444">LEFT</h3>
                    <button class="btn btn-gray" style="font-size:0.8rem; padding:8px 20px;" onclick="switchSide('left')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ù‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ</button>
                    <div id="listLeft" style="width:100%; margin-top:10px;"></div>
                </div>
                <div style="display:flex; flex-direction:column; justify-content:center; align-items:center;">
                    <h1 style="color:#555;">VS</h1>
                    <button id="readyBtn" class="btn btn-gold" style="width:100%; font-size:1rem;" onclick="toggleReady()">‡∏û‡∏£‡πâ‡∏≠‡∏°</button>
                </div>
                <div class="team-col">
                    <h3 style="color:#3b82f6">RIGHT</h3>
                    <button class="btn btn-gray" style="font-size:0.8rem; padding:8px 20px;" onclick="switchSide('right')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ù‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ</button>
                    <div id="listRight" style="width:100%; margin-top:10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="screen" style="background:black;">
        <div id="viewport">
            <div id="world">
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:#333; font-size:1.5rem; pointer-events:none;">BATTLEFIELD</div>
                <div id="baseLeft" class="base" style="left: 100px;">
                    <div class="base-icon" style="color:#ef4444">üè∞</div>
                    <div class="hp-bar"><div id="hpLeft" class="hp-fill" style="background:#ef4444;"></div></div>
                </div>
                <div id="baseRight" class="base" style="right: 100px;">
                    <div class="base-icon" style="color:#3b82f6">üè∞</div>
                    <div class="hp-bar"><div id="hpRight" class="hp-fill" style="background:#3b82f6;"></div></div>
                </div>
                <div id="unitsLayer"></div>
            </div>
        </div>
        <div id="hud">
            <div class="energy-box">‚ö° <span id="energyVal">0</span></div>
            <div class="dock">
                <div class="card" onclick="spawn('sword', 20)"><div class="cost-badge">20</div><div style="font-size:2rem;">‚öîÔ∏è</div><small>‡∏î‡∏≤‡∏ö</small></div>
                <div class="card" onclick="spawn('bow', 40)"><div class="cost-badge">40</div><div style="font-size:2rem;">üèπ</div><small>‡∏ò‡∏ô‡∏π</small></div>
                <div class="card" onclick="spawn('tank', 70)"><div class="cost-badge">70</div><div style="font-size:2rem;">üõ°Ô∏è</div><small>‡πÅ‡∏ó‡∏á‡∏Ñ‡πå</small></div>
                <div class="card" onclick="spawn('mage', 100)"><div class="cost-badge">100</div><div style="font-size:2rem;">üîÆ</div><small>‡πÄ‡∏ß‡∏ó</small></div>
            </div>
        </div>
    </div>

    <div id="resultScreen" class="screen">
        <h1 id="winnerText">WINNER</h1>
        <button class="btn btn-gold" onclick="location.reload()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

    <script>
        const socket = io();
        let myId = null;
        let roomId = null;
        let mySide = null;
        let energy = 0;

        // --- LOBBY ---
        function createRoom() {
            const name = document.getElementById('playerName').value || 'Host';
            const mode = document.getElementById('gameMode').value;
            socket.emit('create_room', { name, mode });
        }
        function joinRoom() {
            const name = document.getElementById('playerName').value || 'Guest';
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            socket.emit('join_room', { roomId: code, name });
        }
        function switchSide(s) { if(roomId) socket.emit('select_side', { roomId, side: s }); }
        function toggleReady() { if(roomId) socket.emit('toggle_ready', roomId); }

        socket.on('room_created', (data) => {
            roomId = data.roomId;
            enterLobby();
        });

        socket.on('update_lobby', (players) => {
            if(!roomId && players.length) roomId = players[0].roomId; // Safety
            document.getElementById('lobbyTitle').innerText = `Room: ${roomId}`;
            
            const l = document.getElementById('listLeft');
            const r = document.getElementById('listRight');
            l.innerHTML=''; r.innerHTML='';
            
            const me = players.find(p => p.id === socket.id);
            if(me) { mySide = me.side; }

            players.forEach(p => {
                const el = document.createElement('div');
                el.className = 'player-item';
                el.style.borderLeftColor = p.color;
                el.innerHTML = `<span>${p.name}</span> <span class="ready-tag ${p.ready?'yes':''}">${p.ready?'READY':'...'}</span>`;
                if(p.side === 'left') l.appendChild(el); 
                else if(p.side === 'right') r.appendChild(el);
            });

            const btn = document.getElementById('readyBtn');
            btn.innerText = me && me.ready ? "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" : "‡∏û‡∏£‡πâ‡∏≠‡∏°";
            btn.className = me && me.ready ? "btn btn-gold" : "btn btn-gray";
            
            renderColorPicker(players);
        });
        
        const PLAYER_COLORS = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#a855f7', '#ec4899'];
        function renderColorPicker(players) {
            const box = document.getElementById('colorPicker');
            box.innerHTML = '';
            PLAYER_COLORS.forEach(c => {
                const isTaken = players.some(p => p.color === c && p.id !== socket.id);
                const btn = document.createElement('div');
                btn.className = `color-btn ${isTaken?'taken':''}`;
                btn.style.backgroundColor = c;
                if(!isTaken) btn.onclick = () => socket.emit('select_color', { roomId, color: c });
                box.appendChild(btn);
            });
        }

        function enterLobby() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('lobbyScreen').classList.add('active');
        }

        // --- GAME START ---
        socket.on('start_game', () => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('gameScreen').style.display = 'block';
            
            const vp = document.getElementById('viewport');
            let startX = mySide === 'right' ? -(1600 - vp.clientWidth) : 0;
            document.getElementById('world').style.transform = `translate(${startX}px, -${(900-vp.clientHeight)/2}px)`;
            
            // Activate camera drag
            initCamera(startX, -(900-vp.clientHeight)/2);
        });

        // --- GAMEPLAY UPDATE ---
        function spawn(type, cost) {
            if(energy >= cost) socket.emit('spawn_request', { roomId, type });
        }

        socket.on('world_update', (data) => {
            // Update Energy & Bases
            energy = Math.floor(data.e[mySide] || 0);
            document.getElementById('energyVal').innerText = energy;
            document.querySelectorAll('.card').forEach(c => {
                const cost = parseInt(c.querySelector('.cost-badge').innerText);
                if(energy < cost) c.classList.add('disabled'); else c.classList.remove('disabled');
            });
            
            document.getElementById('hpLeft').style.width = (data.b.left/10) + '%';
            document.getElementById('hpRight').style.width = (data.b.right/10) + '%';

            // Render Units
            const layer = document.getElementById('unitsLayer');
            const existIds = new Set();
            const ICONS = { sword: '‚öîÔ∏è', bow: 'üèπ', tank: 'üõ°Ô∏è', mage: 'üîÆ' };

            data.u.forEach(u => {
                existIds.add(u.i);
                let el = document.getElementById(u.i);
                if(!el) {
                    el = document.createElement('div');
                    el.id = u.i;
                    el.className = `unit ${u.s}`;
                    el.innerText = ICONS[u.t];
                    el.style.backgroundColor = u.c;
                    el.style.borderColor = u.c;
                    el.style.boxShadow = `0 0 5px ${u.c}`;
                    layer.appendChild(el);
                }
                el.style.left = u.x + 'px';
                el.style.top = u.y + 'px';
                el.style.opacity = (u.h / (u.t==='tank'?80:30)) + 0.3; 
            });

            Array.from(layer.children).forEach(child => {
                if(!existIds.has(child.id)) child.remove();
            });
        });

        socket.on('game_over', (data) => {
            document.getElementById('resultScreen').classList.add('active');
            const txt = document.getElementById('winnerText');
            const win = data.winner === mySide;
            txt.innerText = win ? "VICTORY" : "DEFEAT";
            txt.style.color = win ? "#FFD700" : "#ef4444";
        });

        // --- CAMERA LOGIC ---
        function initCamera(initialX, initialY) {
            const vp = document.getElementById('viewport');
            let camX = initialX, camY = initialY;
            let isDrag=false, startX=0, startY=0, curX=0, curY=0;

            const update = () => document.getElementById('world').style.transform = `translate(${camX}px, ${camY}px)`;
            
            const start = (x, y) => { isDrag=true; startX=x; startY=y; curX=camX; curY=camY; };
            const move = (x, y) => {
                if(!isDrag) return;
                camX = curX + (x - startX);
                camY = curY + (y - startY);
                // Clamp
                if(camX > 0) camX = 0;
                if(camX < -(1600 - vp.clientWidth)) camX = -(1600 - vp.clientWidth);
                if(camY > 0) camY = 0;
                if(camY < -(900 - vp.clientHeight)) camY = -(900 - vp.clientHeight);
                update();
            };

            vp.addEventListener('mousedown', e => start(e.pageX, e.pageY));
            vp.addEventListener('touchstart', e => start(e.touches[0].pageX, e.touches[0].pageY), {passive:false});
            window.addEventListener('mousemove', e => move(e.pageX, e.pageY));
            window.addEventListener('touchmove', e => move(e.touches[0].pageX, e.touches[0].pageY), {passive:false});
            window.addEventListener('mouseup', () => isDrag=false);
            window.addEventListener('touchend', () => isDrag=false);
        }
    </script>
</body>
</html>