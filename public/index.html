<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Battle War: Updates</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;600&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg: #0a0a0a; --gold: #FFD700; }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; font-family: 'Kanit', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
        
        @keyframes walkAnim { 0% { transform: translate(-50%,-50%) rotate(-5deg); } 50% { transform: translate(-50%,-50%) rotate(5deg); } 100% { transform: translate(-50%,-50%) rotate(-5deg); } }
        @keyframes atkAnim { 0% { transform: translate(-50%,-50%) scale(1); } 50% { transform: translate(-50%,-50%) scale(1.4); } 100% { transform: translate(-50%,-50%) scale(1); } }
        @keyframes expand { 0% { transform: translate(-50%,-50%) scale(0); opacity: 0.8; } 100% { transform: translate(-50%,-50%) scale(2); opacity: 0; } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }
        @keyframes spinScope { 0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); } 50% { transform: translate(-50%, -50%) rotate(180deg) scale(0.8); } 100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); } }

        .screen { display: none; width: 100%; height: 100%; position: absolute; z-index: 50; background: var(--bg); flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex !important; }
        
        input, select { padding: 12px; border-radius: 8px; border: 1px solid #333; background: #222; color: white; margin: 5px; width: 80%; max-width: 300px; text-align: center; font-size: 16px; }
        .btn { padding: 12px 25px; border-radius: 25px; border: none; font-weight: bold; margin: 10px; cursor: pointer; font-size: 16px; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-gray { background: #333; color: #ccc; }
        .btn-blue { background: #3b82f6; color: white; box-shadow: 0 0 10px #3b82f6; }

        .lobby-box { width: 90%; max-width: 600px; background: #151515; padding: 20px; border-radius: 15px; border: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        .team-con { display: flex; gap: 10px; margin-top: 15px; min-height: 150px; }
        .team-col { flex: 1; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; }
        .p-card { background: #333; padding: 8px; border-radius: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; font-size: 14px; border-left: 4px solid white; }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; display: inline-block; margin: 3px; cursor: pointer; border: 2px solid transparent; }
        .color-dot.selected { border-color: white; transform: scale(1.1); }
        .color-dot.disabled { opacity: 0.2; pointer-events: none; }
        
        #autoTimer { color: #ff4757; font-size: 18px; font-weight: bold; margin-bottom: 5px; display: none; text-align: center; }

        #viewport { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1; background: #111; touch-action: none; }
        #world { 
            position: absolute; top: 0; left: 0; width: 1600px; height: 900px; 
            background-color: #0f0f0f;
            background-image: linear-gradient(#222 1px, transparent 1px), linear-gradient(90deg, #222 1px, transparent 1px);
            background-size: 100px 100px; border: 2px solid #444;
            transform-origin: 0 0; will-change: transform;
        }
        
        .base { position: absolute; top: 50%; transform: translate(-50%, -50%); z-index: 5; text-align: center; font-size: 50px; }
        .team-name { position: absolute; top: 40%; transform: translate(-50%, -50%); color: #aaa; font-size: 20px; font-weight: bold; white-space: nowrap; z-index: 4; text-shadow: 1px 1px 0 #000; }
        
        .unit { 
            position: absolute; width: 30px; height: 30px; border-radius: 50%; 
            transform: translate(-50%, -50%); z-index: 10; display: flex; 
            justify-content: center; align-items: center; border: 2px solid white;
            font-size: 16px; 
            transition: left 0.2s linear, top 0.2s linear;
        }
        .unit.walk { animation: walkAnim 0.5s infinite linear; }
        .unit.attack { animation: atkAnim 0.2s linear; }
        .u-name { position: absolute; top: -16px; left: 50%; transform: translateX(-50%); font-size: 10px; color: white; white-space: nowrap; font-weight: bold; text-shadow: 1px 1px 0 #000; pointer-events: none; }

        .hp-bar { width: 80px; height: 6px; background: #333; margin: 0 auto; border-radius: 3px; overflow: hidden; }
        .hp-val { height: 100%; width: 100%; transition: width 0.2s; }
        .proj { position: absolute; width: 12px; height: 12px; border-radius: 50%; background: white; z-index: 12; transform: translate(-50%,-50%); border: 2px solid black; }
        .proj.mage { background: #a29bfe; box-shadow: 0 0 8px #a29bfe; }
        .proj.cannon { background: #333; width: 16px; height: 16px; }
        
        .aoe { position: absolute; border: 2px solid white; background: rgba(255,255,255,0.2); border-radius: 50%; z-index: 11; animation: expand 0.4s forwards; }
        .aoe.healer { border-color: #2ed573; background: rgba(46, 213, 115, 0.2); }

        .aim-scope {
            position: absolute; width: 40px; height: 40px;
            border: 2px solid #ff0000; border-radius: 50%;
            z-index: 100; transform: translate(-50%, -50%);
            box-shadow: 0 0 10px red;
            background: rgba(255, 0, 0, 0.1);
            pointer-events: none;
            animation: spinScope 1s infinite linear;
        }
        .aim-scope::after, .aim-scope::before { content: ''; position: absolute; background: #ff0000; }
        .aim-scope::after { top: 50%; left: 0; width: 100%; height: 1px; }
        .aim-scope::before { top: 0; left: 50%; width: 1px; height: 100%; }

        .dmg { position: absolute; color: #ff4757; font-weight: bold; font-size: 20px; z-index: 20; text-shadow: 1px 1px 0 black; animation: floatUp 0.8s forwards; pointer-events: none; }
        .heal-text { position: absolute; color: #2ed573; font-weight: bold; font-size: 20px; z-index: 20; text-shadow: 1px 1px 0 black; animation: floatUp 0.8s forwards; pointer-events: none; }

        .hud-bottom { position: absolute; bottom: 120px; width: 100%; text-align: center; z-index: 100; pointer-events: none; }
        .energy { background: rgba(0,0,0,0.8); color: var(--gold); padding: 5px 20px; border-radius: 20px; border: 1px solid var(--gold); font-size: 24px; font-weight: bold; display: inline-block; }
        
        .dock { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 100; width: 98%; max-width: 700px; justify-content: center; flex-wrap: wrap; }
        .card { width: 62px; height: 75px; background: #222; border: 1px solid #444; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: 0.1s; overflow: hidden; flex-shrink: 0; }
        .card:active { transform: scale(0.95); border-color: var(--gold); }
        .card.disabled { opacity: 0.4; filter: grayscale(1); }
        .c-icon { font-size: 22px; line-height: 1; margin-bottom: 2px; }
        .c-cost { font-size: 10px; color: var(--gold); background: black; padding: 1px 5px; border-radius: 8px; }
        .c-limit { font-size: 10px; color: #fff; margin-top: 2px; background: rgba(0,0,0,0.5); border-radius:4px; padding:0 2px; }

        .cd-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(0, 0, 0, 0.7); z-index: 10; pointer-events: none; }
        .card.cooldown-active { pointer-events: none; }
        .card.cooldown-active .cd-overlay { height: 100%; transition: none; }
        .card.cooldown-anim .cd-overlay { height: 0%; transition: height 3s linear; }

        #chatCon { position: absolute; top: 10px; left: 10px; width: 280px; height: 160px; z-index: 100; display: flex; flex-direction: column; pointer-events: none; }
        #chatBox { flex: 1; overflow-y: auto; padding: 8px; color: white; font-size: 13px; pointer-events: auto; background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px 8px 0 0; margin-bottom: 2px; }
        #chatBox div { text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; }
        .chat-input-row { display: flex; width: 100%; pointer-events: auto; }
        #chatInp { flex: 1; margin: 0; background: rgba(0,0,0,0.8); padding: 8px; color: white; border-radius: 0 0 0 8px; border: 1px solid #444; width: auto; max-width: none; }
        #chatSendBtn { width: 60px; background: var(--gold); border: none; border-radius: 0 0 8px 0; font-weight: bold; color: black; cursor: pointer; }
        #chatSendBtn:active { background: #e5c100; }

        .loader { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="menuScreen" class="screen active">
        <h1 style="color:var(--gold); font-size:40px;">BATTLE WAR</h1>
        <p style="color:#777; margin-bottom:20px;">Chase & UI Update</p>
        <input type="text" id="pName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£" maxlength="10">
        
        <button class="btn btn-blue" style="width:80%; max-width:300px; padding:15px; font-size:20px;" onclick="startMatchmaking()">üîç Auto Match (1v1)</button>
        
        <div style="width:80%; height:1px; background:#333; margin:15px 0;"></div>
        
        <select id="gMode" onchange="toggleBot()">
            <option value="1v1">Custom 1 vs 1</option>
            <option value="2v2">Custom 2 vs 2</option>
            <option value="bot">Play vs Bot</option>
        </select>
        <div id="botOpt" style="display:none; width:100%; text-align:center;">
            <select id="bDiff" style="width:50%;"><option value="easy">Easy</option><option value="normal" selected>Normal</option><option value="hard">Hard</option></select>
        </div>
        <button class="btn btn-gold" onclick="createRoom()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏á</button>
        <div style="display:flex; gap:5px; width:80%; max-width:300px;">
            <input type="text" id="rCode" placeholder="Code" style="margin:0;">
            <button class="btn btn-gray" onclick="joinRoom()" style="margin:0;">Join</button>
        </div>
        <div id="msg" style="color:#ff4757; margin-top:10px;"></div>
    </div>

    <div id="matchScreen" class="screen">
        <h2 style="color:white;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ...</h2>
        <div class="loader"></div>
        <p style="color:#aaa;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì</p>
        <button class="btn btn-gray" onclick="cancelMatch()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <div id="lobbyScreen" class="screen">
        <div class="lobby-box">
            <div style="display:flex; justify-content:space-between;">
                <h2 id="lTitle">Room</h2>
                <button class="btn btn-gray" style="padding:5px 10px; font-size:12px;" onclick="location.reload()">‡∏≠‡∏≠‡∏Å</button>
            </div>
            
            <div id="autoTimer">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô: <span id="timerNum">30</span>s</div>

            <div id="cPal" style="margin:10px 0; text-align:center;"></div>
            <div class="team-con">
                <div class="team-col">
                    <h3 style="color:#3b82f6; text-align:center;">Left</h3>
                    <button class="btn btn-gray" style="width:100%; padding:5px;" onclick="sSide('left')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á</button>
                    <div id="listL" style="margin-top:5px;"></div>
                </div>
                <div style="display:flex; flex-direction:column; justify-content:center;">
                    <button id="rBtn" class="btn btn-gold" onclick="tReady()">‡∏û‡∏£‡πâ‡∏≠‡∏°</button>
                </div>
                <div class="team-col">
                    <h3 style="color:#ef4444; text-align:center;">Right</h3>
                    <button class="btn btn-gray" style="width:100%; padding:5px;" onclick="sSide('right')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á</button>
                    <div id="listR" style="margin-top:5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="screen" style="background:black;">
        <div id="viewport">
            <div id="world">
                <div id="nameL" class="team-name" style="left: 100px;"></div>
                <div id="nameR" class="team-name" style="right: 100px;"></div>
                <div class="base" style="left:100px; color:#3b82f6;">üè∞<div class="hp-bar"><div id="hpL" class="hp-val" style="background:#3b82f6;"></div></div></div>
                <div class="base" style="right:100px; color:#ef4444;">üè∞<div class="hp-bar"><div id="hpR" class="hp-val" style="background:#ef4444;"></div></div></div>
                <div id="uLayer"></div>
                <div id="fxLayer"></div>
            </div>
        </div>
        
        <div id="chatCon">
            <div id="chatBox"></div>
            <div class="chat-input-row">
                <input id="chatInp" type="text" placeholder="‡πÅ‡∏ä‡∏ó..." onkeydown="checkEnter(event)">
                <button id="chatSendBtn" onclick="sendMsg()">‡∏™‡πà‡∏á</button>
            </div>
        </div>

        <div class="hud-bottom"><div class="energy">‚ö° <span id="eng">0</span>/300</div></div>
        
        <div class="dock">
            <div id="card-sword" class="card" onclick="spawn('sword',20)"><span class="c-icon">‚öîÔ∏è</span><span class="c-cost">20</span><span class="c-limit" id="lim-sword">0/40</span><div class="cd-overlay"></div></div>
            <div id="card-bow" class="card" onclick="spawn('bow',45)"><span class="c-icon">üèπ</span><span class="c-cost">45</span><span class="c-limit" id="lim-bow">0/30</span><div class="cd-overlay"></div></div>
            <div id="card-assassin" class="card" onclick="spawn('assassin',80)"><span class="c-icon">ü•∑</span><span class="c-cost">80</span><span class="c-limit" id="lim-assassin">0/40</span><div class="cd-overlay"></div></div>
            <div id="card-tank" class="card" onclick="spawn('tank',75)"><span class="c-icon">üõ°Ô∏è</span><span class="c-cost">75</span><span class="c-limit" id="lim-tank">0/40</span><div class="cd-overlay"></div></div>
            <div id="card-healer" class="card" onclick="spawn('healer',50)"><span class="c-icon">‚öïÔ∏è</span><span class="c-cost">50</span><span class="c-limit" id="lim-healer">0/30</span><div class="cd-overlay"></div></div>
            <div id="card-mage" class="card" onclick="spawn('mage',125)"><span class="c-icon">üîÆ</span><span class="c-cost">125</span><span class="c-limit" id="lim-mage">0/30</span><div class="cd-overlay"></div></div>
            <div id="card-sniper" class="card" onclick="spawn('sniper',100)"><span class="c-icon">üî´</span><span class="c-cost">100</span><span class="c-limit" id="lim-sniper">0/30</span><div class="cd-overlay"></div></div>
            <div id="card-cannon" class="card" onclick="spawn('cannon',175)"><span class="c-icon">üí£</span><span class="c-cost">175</span><span class="c-limit" id="lim-cannon">0/15</span><div class="cd-overlay"></div></div>
        </div>
    </div>

    <script>
        const socket = io();
        let rid=null, mySide=null, eng=0;
        let timerInterval = null;
        let lastCastTime = 0; // *FIXED: ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ Sync

        const ICONS = { sword:'‚öîÔ∏è', bow:'üèπ', tank:'üõ°Ô∏è', mage:'üîÆ', assassin:'ü•∑', cannon:'üí£', healer:'‚öïÔ∏è', sniper:'üî´' };
        const LIMITS = { sword:40, tank:40, assassin:40, bow:30, mage:30, healer:30, sniper:30, cannon:15 };

        // --- MENU & LOBBY ---
        function toggleBot(){ document.getElementById('botOpt').style.display = document.getElementById('gMode').value==='bot'?'block':'none'; }
        function createRoom(){ socket.emit('create_room', { name: v('pName')||'Host', mode: v('gMode'), difficulty: v('bDiff') }); }
        function joinRoom(){ const c=v('rCode'); if(c) socket.emit('join_room', { roomId:c, name: v('pName')||'Joiner' }); else alert('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á'); }
        function v(id){ return document.getElementById(id).value; }
        
        socket.on('join_success', d=>{ 
            rid=d.roomId; 
            toScr('lobbyScreen'); 
            document.getElementById('autoTimer').style.display = d.isAuto ? 'block' : 'none';
        });

        socket.on('auto_match_timer', d=>{
            let sec = d.seconds;
            const el = document.getElementById('timerNum');
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(()=>{
                sec--; el.innerText = sec;
                if(sec <= 0) clearInterval(timerInterval);
            }, 1000);
        });

        socket.on('room_created', d=>{ rid=d.roomId; toScr('lobbyScreen'); document.getElementById('autoTimer').style.display = 'none'; });
        socket.on('error_msg', m=>alert(m));

        socket.on('update_lobby', d=>{
            document.getElementById('lTitle').innerText = `Room: ${rid}`;
            const l=document.getElementById('listL'), r=document.getElementById('listR'), pBox=document.getElementById('cPal');
            l.innerHTML=''; r.innerHTML=''; pBox.innerHTML='';
            
            const me = d.players.find(p=>p.id===socket.id);
            if(me) mySide = me.side;

            d.colors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = `color-dot ${me && me.color===c ? 'selected' : ''}`;
                if(d.players.some(p=>p.color===c && p.id!==socket.id)) dot.classList.add('disabled');
                dot.style.background = c;
                dot.onclick = () => socket.emit('select_color', { roomId:rid, color:c });
                pBox.appendChild(dot);
            });

            d.players.forEach(p=>{
                const div = document.createElement('div');
                div.className = 'p-card'; div.style.borderLeftColor = p.color;
                div.innerHTML = `<span>${p.name}</span><span>${p.ready?'‚úÖ':'...'}</span>`;
                if(p.side==='left') l.appendChild(div); else if(p.side==='right') r.appendChild(div);
            });
            
            if(me) {
                const b=document.getElementById('rBtn');
                b.innerText = me.ready?"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å":"‡∏û‡∏£‡πâ‡∏≠‡∏°";
                b.className = me.ready?"btn btn-gold":"btn btn-gray";
            }
        });

        function sSide(s){ socket.emit('select_side', { roomId:rid, side:s }); }
        function tReady(){ socket.emit('toggle_ready', rid); }
        function toScr(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        function startMatchmaking() {
            const name = v('pName') || 'Player';
            socket.emit('find_match', { name });
            toScr('matchScreen');
        }
        function cancelMatch() { socket.emit('cancel_match'); toScr('menuScreen'); }

        // --- GAME LOGIC ---
        socket.on('start_game', (data)=>{ 
            if(timerInterval) clearInterval(timerInterval);
            toScr('gameScreen'); 
            initCamera(); 

            const leftNames = data.players.filter(p=>p.side==='left').map(p=>p.name).join(', ');
            const rightNames = data.players.filter(p=>p.side==='right').map(p=>p.name).join(', ');
            document.getElementById('nameL').innerText = leftNames;
            document.getElementById('nameR').innerText = rightNames;
        });

        function spawn(t,c){ 
            const cardEl = document.getElementById('card-' + t);
            const limEl = document.getElementById('lim-' + t);
            const [cur, max] = limEl.innerText.split('/').map(Number);
            if(cur >= max) return; 

            if(eng >= c && !cardEl.classList.contains('cooldown-active')) { 
                
                // *FIXED: ‡∏´‡∏±‡∏Å‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Prediction)
                eng -= c; 
                document.getElementById('eng').innerText = Math.floor(eng);
                lastCastTime = Date.now(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
                // ---------------------------------

                socket.emit('spawn_request', { roomId:rid, type:t }); 
                cardEl.classList.add('cooldown-active'); 
                void cardEl.offsetWidth; 
                cardEl.classList.add('cooldown-anim'); 
                setTimeout(() => { cardEl.classList.remove('cooldown-active', 'cooldown-anim'); }, 3000);
            } 
        }
        
        function checkEnter(e) { if(e.key === 'Enter') sendMsg(); }
        function sendMsg() {
            const inp = document.getElementById('chatInp');
            if(inp.value.trim()) {
                socket.emit('send_chat', { roomId: rid, msg: inp.value.trim() });
                inp.value = '';
            }
        }
        
        socket.on('chat_msg', d=>{
            const b=document.getElementById('chatBox');
            b.innerHTML += `<div style="color:${d.color}"><b>${d.name}:</b> ${d.msg}</div>`;
            b.scrollTop=b.scrollHeight;
        });

        socket.on('world_update', d=>{
            // *FIXED: Logic Sync ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏µ‡∏Å‡∏±‡∏ô
            const now = Date.now();
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏Å‡∏î‡∏™‡∏Å‡∏¥‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 600ms ‡πÅ‡∏•‡πâ‡∏ß Server ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà "‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤" ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤ (‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)
            if (now - lastCastTime < 600 && d.myEng > eng) {
                // ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ (‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß) ‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏ö‡∏ö‡∏ß‡∏Å Regen ‡∏ó‡∏¥‡∏û‡∏¢‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡πÜ
                eng += 0.2; 
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Å‡πá Sync ‡∏ï‡∏≤‡∏° Server
                eng = d.myEng; 
            }
            
            document.getElementById('eng').innerText = Math.floor(eng); 
            // -------------------------------------------
            
            const myCounts = {};
            d.u.forEach(u => {
                if(u.s === mySide) {
                    myCounts[u.t] = (myCounts[u.t] || 0) + 1;
                }
            });

            document.querySelectorAll('.card').forEach(c=>{
                if (!c.classList.contains('cooldown-active')) {
                    const cost = parseInt(c.querySelector('.c-cost').innerText);
                    const type = c.id.replace('card-','');
                    const curCount = myCounts[type] || 0;
                    const maxCount = LIMITS[type];
                    const limText = document.getElementById('lim-' + type);
                    if(limText) limText.innerText = `${curCount}/${maxCount}`;
                    if(eng < cost || curCount >= maxCount) c.classList.add('disabled'); else c.classList.remove('disabled');
                }
            });

            document.getElementById('hpL').style.width = (d.b.left/10)+'%';
            document.getElementById('hpR').style.width = (d.b.right/10)+'%';

            const uL = document.getElementById('uLayer');
            const fxL = document.getElementById('fxLayer');
            const exist = new Set();
            const aimingAt = new Set(); 

            d.u.forEach(u=>{
                exist.add(u.i);
                let el = document.getElementById(u.i);
                if(!el){
                    el = document.createElement('div'); el.id=u.i; el.className='unit';
                    el.style.background=u.c; el.style.borderColor=u.c;
                    el.style.boxShadow=`0 0 5px ${u.c}`;
                    el.innerHTML = `<div class="u-name">${u.n}</div>${ICONS[u.t]}`;
                    uL.appendChild(el);
                }
                el.style.left = u.x+'px'; el.style.top = u.y+'px';
                
                el.classList.remove('walk', 'attack');
                if(u.act === 'walk') el.classList.add('walk');
                else if(u.act === 'attack') el.classList.add('attack');

                if(u.aimTarget) {
                    aimingAt.add(u.aimTarget);
                    let targetEl = document.getElementById(u.aimTarget);
                    let scopeId = 'scope_' + u.i;
                    let scopeEl = document.getElementById(scopeId);
                    
                    if(targetEl) {
                        if(!scopeEl) {
                            scopeEl = document.createElement('div'); scopeEl.id = scopeId; scopeEl.className = 'aim-scope'; fxL.appendChild(scopeEl);
                        }
                        scopeEl.style.left = targetEl.style.left; scopeEl.style.top = targetEl.style.top;
                    } else if (scopeEl) { scopeEl.remove(); }
                } else {
                    let scopeEl = document.getElementById('scope_' + u.i);
                    if(scopeEl) scopeEl.remove();
                }
            });

            Array.from(uL.children).forEach(e=>{ if(!exist.has(e.id)) e.remove(); });
            
            document.querySelectorAll('.aim-scope').forEach(scope => {
                const sniperId = scope.id.replace('scope_', '');
                if (!exist.has(sniperId)) scope.remove();
            });

            document.querySelectorAll('.proj').forEach(e=>e.remove());
            d.proj.forEach(p=>{
                const el = document.createElement('div'); el.className=`proj ${p.t}`;
                el.style.left=p.x+'px'; el.style.top=p.y+'px';
                fxL.appendChild(el);
            });

            d.fx.forEach(f=>{
                if(f.type==='dmg'){
                    const e=document.createElement('div'); e.className='dmg'; e.innerText=`-${f.val}`;
                    e.style.left=f.x+'px'; e.style.top=(f.y-20)+'px';
                    fxL.appendChild(e); setTimeout(()=>e.remove(),800);
                } 
                else if(f.type==='heal'){
                    const e=document.createElement('div'); e.className='heal-text'; e.innerText=`+${f.val}`;
                    e.style.left=f.x+'px'; e.style.top=(f.y-30)+'px';
                    fxL.appendChild(e); setTimeout(()=>e.remove(),800);
                }
                else if(f.type==='aoe'){
                    const e=document.createElement('div'); e.className='aoe'; 
                    if(f.t === 'healer') e.classList.add('healer');
                    e.style.left=f.x+'px'; e.style.top=f.y+'px';
                    e.style.width=(f.r*2)+'px'; e.style.height=(f.r*2)+'px';
                    if(f.t === 'assassin') e.style.borderColor = '#ff4757'; 
                    fxL.appendChild(e); setTimeout(()=>e.remove(),400);
                } else if(f.type==='warp'){
                    const e=document.createElement('div'); e.innerText='üí®'; e.style.position='absolute';
                    e.style.left=f.x+'px'; e.style.top=f.y+'px'; e.style.fontSize='25px';
                    fxL.appendChild(e); setTimeout(()=>e.remove(),500);
                }
            });
        });

        socket.on('game_over', d=>{ alert(d.winner===mySide?"‡∏ä‡∏ô‡∏∞!":"‡πÅ‡∏û‡πâ!"); location.reload(); });

        // --- CAMERA SYSTEM ---
        function initCamera() {
            const vp = document.getElementById('viewport');
            const world = document.getElementById('world');
            let state = { x: mySide === 'right' ? -(1600 - vp.clientWidth) : 0, y: -(900 - vp.clientHeight) / 2, scale: 1 };
            const MIN_SCALE = 0.5, MAX_SCALE = 1.5, WORLD_W = 1600, WORLD_H = 900;
            function updateTransform() {
                const minX = vp.clientWidth - (WORLD_W * state.scale);
                const minY = vp.clientHeight - (WORLD_H * state.scale);
                if (minX > 0) state.x = minX / 2; else state.x = Math.max(minX, Math.min(0, state.x));
                if (minY > 0) state.y = minY / 2; else state.y = Math.max(minY, Math.min(0, state.y));
                world.style.transform = `translate3d(${state.x}px, ${state.y}px, 0) scale(${state.scale})`;
            }
            let lastDist = 0, startX = 0, startY = 0, isDragging = false;
            vp.addEventListener('touchstart', (e) => {
                if(e.touches.length === 1) { isDragging = true; startX = e.touches[0].clientX - state.x; startY = e.touches[0].clientY - state.y; } 
                else if (e.touches.length === 2) { isDragging = false; lastDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); }
            }, {passive: false});
            vp.addEventListener('touchmove', (e) => {
                e.preventDefault(); 
                if (e.touches.length === 1 && isDragging) { state.x = e.touches[0].clientX - startX; state.y = e.touches[0].clientY - startY; updateTransform(); } 
                else if (e.touches.length === 2) {
                    const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    if (lastDist) { const delta = dist - lastDist; const newScale = state.scale + (delta * 0.005); state.scale = Math.min(Math.max(newScale, MIN_SCALE), MAX_SCALE); updateTransform(); }
                    lastDist = dist;
                }
            }, {passive: false});
            vp.addEventListener('touchend', () => { isDragging = false; lastDist = 0; });
            vp.addEventListener('mousedown', (e) => { isDragging = true; startX = e.clientX - state.x; startY = e.clientY - state.y; });
            window.addEventListener('mousemove', (e) => { if(!isDragging) return; state.x = e.clientX - startX; state.y = e.clientY - startY; updateTransform(); });
            window.addEventListener('mouseup', () => isDragging = false);
            vp.addEventListener('wheel', (e) => { e.preventDefault(); const delta = -Math.sign(e.deltaY) * 0.1; const newScale = state.scale + delta; state.scale = Math.min(Math.max(newScale, MIN_SCALE), MAX_SCALE); updateTransform(); }, {passive: false});
            updateTransform();
        }
    </script>
</body>
</html>